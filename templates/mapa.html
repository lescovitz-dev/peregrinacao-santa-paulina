{% extends "base.html" %}
{% block content %}

<h2>ğŸ—ºï¸ Mapa da PeregrinaÃ§Ã£o</h2>

<div style="margin-bottom: 1rem;">
<button id="btn-dia1" onclick="mostrarDia(1)" class="botao-dia ativo">
    ğŸ“ Dia 1
  </button>
  <button id="btn-dia2" onclick="mostrarDia(2)" class="botao-dia">
    ğŸ“ Dia 2
  </button>
  <p style="margin-top: 0.8rem;">
  <a href="/mapa/apoios" class="botao-secundario">
    ğŸ“‹ Ver lista detalhada dos pontos de apoio
  </a>
  </p>
</div>

<div id="map" style="height: 65vh; width: 100%; border-radius: 12px;"></div>

<!-- Leaflet CSS -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>
<script src="{{ url_for('static', filename='mapa-dados.js') }}"></script>
<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
/* ======================================================
   MAPA BASE
====================================================== */
const map = L.map("map").setView([-27.100, -48.600], 10);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  attribution: "Â© OpenStreetMap"
}).addTo(map);

let markersLayer = L.layerGroup().addTo(map);

/* ======================================================
   ÃCONES POR CARRO DE APOIO
====================================================== */
function iconeCarro(carro) {
  const cores = {
    1: "red",
    2: "blue",
    3: "green",
    4: "purple"
  };

  return L.divIcon({
    html: `<div style="
      background:${cores[carro]};
      width:16px;
      height:16px;
      border-radius:50%;
      border:2px solid white;"></div>`,
    className: "",
    iconSize: [16, 16]
  });
}
function iconeInicio() {
  return L.divIcon({
    html: `<div style="
      background:#007bff;
      width:18px;
      height:18px;
      border-radius:50%;
      border:3px solid white;
      box-shadow:0 0 4px rgba(0,0,0,0.4);
    "></div>`,
    className: "",
    iconSize: [18, 18]
  });
}

function iconeFim() {
  return L.divIcon({
    html: `<div style="
      background:#28a745;
      width:18px;
      height:18px;
      border-radius:50%;
      border:3px solid white;
      box-shadow:0 0 4px rgba(0,0,0,0.4);
    "></div>`,
    className: "",
    iconSize: [18, 18]
  });
}

/* ======================================================
   DADOS EDITÃVEIS â€“ PONTOS DE APOIO
====================================================== */

/* ğŸ”¹ DIA 1 */
const apoiosDia1 = [
  { km: 6,  lat: -27.000923, lng: -49.038497, carro: 1, nome: "Apoio 1 â€“ Van Maria" },
  { km: 9, lat: -27.019043, lng: -49.023349, carro: 2, nome: "Apoio 2 â€“ Kombi JosÃ©" },
  { km: 12.3, lat: -27.036939, lng: -49.020904, carro: 3, nome: "Apoio 3 â€“ Caminhonete Paulo" },
  { km: 14.6, lat: -27.045777, lng: -49.013245, carro: 4, nome: "Apoio 4 â€“ Van Ana" },
  { km: 18.4, lat: -27.069221, lng: -48.998240, carro: 1, nome: "Apoio 5 â€“ Van Maria" },
  { km: 21.7, lat: -27.094183, lng: -48.985138, carro: 1, nome: "Apoio 6 â€“ Van Maria" },
  { km: 24.3, lat: -27.095984, lng: -48.961751, carro: 1, nome: "Apoio 7 â€“ Van Maria" }
];

/* ğŸ”¹ DIA 2 */
const apoiosDia2 = [
  { km: 4.2,  lat: -27.124129, lng: -48.936247, carro: 2, nome: "Apoio 1 â€“ Kombi JosÃ©" },
  { km: 9.7, lat: -27.159833, lng: -48.955933, carro: 3, nome: "Apoio 2 â€“ Caminhonete Paulo" }, 
  { km: 12.4, lat: -27.180118, lng: -48.967557, carro: 4, nome: "Apoio 3 â€“ Van Ana" }, 
  { km: 15.4, lat: -27.194496, lng: -48.951509, carro: 1, nome: "Apoio 4 â€“ Van Maria" }, 
  { km: 16, lat: -27.195427, lng: -48.946533, carro: 1, nome: "Apoio 5 â€“ Van Maria" },
  { km: 17.2, lat: -27.204119, lng: -48.942808, carro: 1, nome: "Apoio 6 â€“ Van Maria" }, 
  { km: 18.8, lat: -27.214468, lng: -48.934438, carro: 1, nome: "Apoio 7 â€“ Van Maria" }, 
  { km: 21.2, lat: -27.232121, lng: -48.939720, carro: 1, nome: "Apoio 8 â€“ Van Maria" }
];

/* ======================================================
   TRAJETO DO PERCURSO (EDITÃVEL)
====================================================== */

/* ğŸ”¹ DIA 1 â€“ percurso aproximado */
const trajetoDia1 = [
  [-26.964034, -49.058889],
  [-27.000923, -49.038497],
  [-27.019043, -49.023349],
  [-27.036939, -49.020904],
  [-27.045777, -49.013245],
  [-27.069221, -48.998240],
  [-27.094183, -48.985138],
  [-27.095984, -48.961751],
  [-27.096353, -48.914205]
];

/* ğŸ”¹ DIA 2 */
const trajetoDia2 = [
  [-27.096287, -48.914279], 
  [-27.124129, -48.936247],
  [-27.159833, -48.955933],
  [-27.180118, -48.967557],
  [-27.194496, -48.951509],
  [-27.195427, -48.946533],
  [-27.204119, -48.942808],
  [-27.214468, -48.934438],
  [-27.232121, -48.939720],
  [-27.252097, -48.942098]
];

let linhaTrajeto = null;

/* ======================================================
   RENDERIZAÃ‡ÃƒO
====================================================== */
function mostrarDia(dia) {
    atualizarBotoesDia(dia);
  markersLayer.clearLayers();

  if (linhaTrajeto) {
    map.removeLayer(linhaTrajeto);
  }

  const dados = dia === 1 ? apoiosDia1 : apoiosDia2;
  const trajeto = dia === 1 ? trajetoDia1 : trajetoDia2;

  /* ğŸ”¹ DESENHA O TRAJETO */
  linhaTrajeto = L.polyline(trajeto, {
    color: "#0b4f6c",
    weight: 5,
    opacity: 0.85
  }).addTo(map);

  /* ==================================================
     ğŸ‘‰ PASSO 2 Ã‰ AQUI ğŸ‘ˆ
     INÃCIO E CHEGADA DO DIA
  ================================================== */

  const inicio = trajeto[0];
  L.marker(inicio, { icon: iconeInicio() })
    .addTo(markersLayer)
    .bindPopup(`ğŸš© <strong>InÃ­cio â€“ Dia ${dia}</strong>`);

  const fim = trajeto[trajeto.length - 1];
  L.marker(fim, { icon: iconeFim() })
    .addTo(markersLayer)
    .bindPopup(`ğŸ <strong>Chegada â€“ Dia ${dia}</strong>`);

  /* ==================================================
     PONTOS DE APOIO
  ================================================== */

 dados.forEach(p => {
    L.marker([p.lat, p.lng], { icon: iconeCarro(p.carro) })
      .addTo(markersLayer)
      .bindPopup(`
        <strong>ğŸšŒ ${p.nome}</strong><br>
        ğŸ“ Km ${p.km}<br>
        ğŸš— Carro ${p.carro}<br>
        ğŸ“… Dia ${dia}
      `);
  });

  /* ğŸ”¹ AJUSTA ZOOM */
  const grupo = L.featureGroup([
    linhaTrajeto,
    ...markersLayer.getLayers()
  ]);

  map.fitBounds(grupo.getBounds(), { padding: [20, 20] });
}
function atualizarBotoesDia(dia) {
  const btn1 = document.getElementById("btn-dia1");
  const btn2 = document.getElementById("btn-dia2");

  btn1.classList.remove("ativo");
  btn2.classList.remove("ativo");

  if (dia === 1) {
    btn1.classList.add("ativo");
  } else {
    btn2.classList.add("ativo");
  }
}
/* ======================================================
   INICIALIZA COM DIA 1
====================================================== */
mostrarDia(1);


/* ======================================================
   LOCALIZAÃ‡ÃƒO DO USUÃRIO (GPS)
====================================================== */

let marcadorUsuario = null;

function localizarUsuario() {
  if (!navigator.geolocation) {
    console.warn("GeolocalizaÃ§Ã£o nÃ£o suportada.");
    return;
  }

  navigator.geolocation.watchPosition(
    pos => {
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;

      if (!marcadorUsuario) {
        marcadorUsuario = L.circleMarker([lat, lng], {
          radius: 8,
          color: "#d9534f",
          fillColor: "#d9534f",
          fillOpacity: 1
        })
          .addTo(map)
          .bindPopup("ğŸ“ VocÃª estÃ¡ aqui");
      } else {
        marcadorUsuario.setLatLng([lat, lng]);
      }
    },
    err => {
      console.warn("Erro GPS:", err.message);
    },
    {
      enableHighAccuracy: true,
      maximumAge: 10000,
      timeout: 10000
    }
  );
}

/* ğŸ”¹ Inicia automaticamente */
localizarUsuario();

</script>
{% endblock %}
