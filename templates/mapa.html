{% extends "base.html" %}
{% block content %}

<h2>üó∫Ô∏è Mapa da Peregrina√ß√£o</h2>

<div style="margin-bottom: 1rem;">
  <button id="btn-dia1" class="botao-dia ativo" onclick="mostrarDia(1)">üìç Dia 1</button>
  <button id="btn-dia2" class="botao-dia" onclick="mostrarDia(2)">üìç Dia 2</button>

  <p style="margin-top: 0.8rem;">
    <a href="/mapa/apoios" class="botao-secundario">
      üìã Ver lista detalhada dos pontos de apoio
    </a>
  </p>
</div>

<div id="map" style="height:65vh; width:100%; border-radius:12px;"></div>

<div id="botao-navegacao" style="margin-top:1rem; text-align:center;">
  <button class="botao-principal" onclick="abrirGoogleMapsComGPS()">
    üß≠ Navegar percurso ‚Äì Dia 1
  </button>
</div>

<div id="distancia-chegada" style="
  margin-top:0.6rem;
  text-align:center;
  font-size:0.9rem;
  color:#444;
">
  üìç Aguardando localiza√ß√£o‚Ä¶
</div>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
/* ======================================================
   VARI√ÅVEIS GLOBAIS
====================================================== */
let diaSelecionado = 1;
let posicaoUsuario = null;
let marcadorUsuario = null;
let linhaTrajeto = null;

const map = L.map("map").setView([-27.10, -48.60], 10);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  attribution: "¬© OpenStreetMap"
}).addTo(map);

const markersLayer = L.layerGroup().addTo(map);

/* ======================================================
   √çCONES
====================================================== */
function iconeCarro(carro) {
  const cores = {1:"red",2:"blue",3:"green",4:"purple"};
  return L.divIcon({
    html:`<div style="background:${cores[carro]};
      width:16px;height:16px;border-radius:50%;
      border:2px solid white"></div>`,
    className:""
  });
}

function iconeInicio() {
  return L.divIcon({
    html:`<div style="
      background:#007bff;color:white;
      width:28px;height:28px;border-radius:50%;
      display:flex;align-items:center;justify-content:center;
      border:3px solid white;">üö©</div>`,
    iconSize:[28,28], iconAnchor:[14,28]
  });
}

function iconeFim() {
  return L.divIcon({
    html:`<div style="
      background:#28a745;color:white;
      width:28px;height:28px;border-radius:50%;
      display:flex;align-items:center;justify-content:center;
      border:3px solid white;">üèÅ</div>`,
    iconSize:[28,28], iconAnchor:[14,28]
  });
}

/* ======================================================
   DADOS ‚Äì APOIOS E TRAJETOS
====================================================== */
const apoiosDia1 = [
  { km:6, lat:-27.000923, lng:-49.038497, carro:1, nome:"Apoio 1 ‚Äì Van Maria" },
  { km:9, lat:-27.019043, lng:-49.023349, carro:2, nome:"Apoio 2 ‚Äì Kombi Jos√©" },
  { km:12.3, lat:-27.036939, lng:-49.020904, carro:3, nome:"Apoio 3 ‚Äì Caminhonete Paulo" },
  { km:14.6, lat:-27.045777, lng:-49.013245, carro:4, nome:"Apoio 4 ‚Äì Van Ana" },
  { km:18.4, lat:-27.069221, lng:-48.998240, carro:1, nome:"Apoio 5 ‚Äì Van Maria" }
];

const apoiosDia2 = [
  { km:4.2, lat:-27.124129, lng:-48.936247, carro:2, nome:"Apoio 1 ‚Äì Kombi Jos√©" },
  { km:9.7, lat:-27.159833, lng:-48.955933, carro:3, nome:"Apoio 2 ‚Äì Caminhonete Paulo" },
  { km:12.4, lat:-27.180118, lng:-48.967557, carro:4, nome:"Apoio 3 ‚Äì Van Ana" }
];

const trajetoDia1 = [
  [-26.964034,-49.058889],
  [-27.000923,-49.038497],
  [-27.036939,-49.020904],
  [-27.095984,-48.961751]
];

const trajetoDia2 = [
  [-27.096287,-48.914279],
  [-27.159833,-48.955933],
  [-27.232121,-48.939720]
];

/* ======================================================
   RENDERIZA√á√ÉO
====================================================== */
function mostrarDia(dia) {
  diaSelecionado = dia;
  atualizarBotoes();

  markersLayer.clearLayers();
  if (linhaTrajeto) map.removeLayer(linhaTrajeto);

  const apoios = dia === 1 ? apoiosDia1 : apoiosDia2;
  const trajeto = dia === 1 ? trajetoDia1 : trajetoDia2;

  linhaTrajeto = L.polyline(trajeto, {
    color:"#0b4f6c", weight:5, opacity:0.85
  }).addTo(map);

  L.marker(trajeto[0], {icon:iconeInicio()}).addTo(markersLayer);
  L.marker(trajeto[trajeto.length-1], {icon:iconeFim()}).addTo(markersLayer);

  apoios.forEach(p=>{
    L.marker([p.lat,p.lng],{icon:iconeCarro(p.carro)})
      .addTo(markersLayer)
      .bindPopup(`<strong>${p.nome}</strong><br>Km ${p.km}`);
  });

  const grupo = L.featureGroup([linhaTrajeto, ...markersLayer.getLayers()]);
  map.fitBounds(grupo.getBounds(), {padding:[20,20]});

  document.querySelector("#botao-navegacao button").innerText =
    `üß≠ Navegar percurso ‚Äì Dia ${dia}`;
}

/* ======================================================
   BOT√ïES
====================================================== */
function atualizarBotoes(){
  document.getElementById("btn-dia1").classList.toggle("ativo", diaSelecionado===1);
  document.getElementById("btn-dia2").classList.toggle("ativo", diaSelecionado===2);
}

/* ======================================================
   GPS + DIST√ÇNCIA
====================================================== */
function localizarUsuario(){
  if(!navigator.geolocation) return;

  navigator.geolocation.watchPosition(pos=>{
    const lat = pos.coords.latitude;
    const lng = pos.coords.longitude;
    posicaoUsuario = [lat,lng];

    if(!marcadorUsuario){
      marcadorUsuario = L.circleMarker([lat,lng],{
        radius:8,color:"#d9534f",fillColor:"#d9534f",fillOpacity:1
      }).addTo(map);
    } else {
      marcadorUsuario.setLatLng([lat,lng]);
    }

    atualizarDistancia(lat,lng);
  });
}

function atualizarDistancia(lat,lng){
  const trajeto = diaSelecionado===1?trajetoDia1:trajetoDia2;
  const fim = trajeto[trajeto.length-1];
  const d = calcularDistancia(lat,lng,fim[0],fim[1]);
  document.getElementById("distancia-chegada").innerHTML =
    `üìç <strong>Dist√¢ncia at√© a chegada:</strong> ${d.toFixed(1)} km<br>
     <small>Estimativa em linha reta (GPS)</small>`;
}

function calcularDistancia(lat1,lon1,lat2,lon2){
  const R=6371;
  const dLat=(lat2-lat1)*Math.PI/180;
  const dLon=(lon2-lon1)*Math.PI/180;
  const a=Math.sin(dLat/2)**2 +
    Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*
    Math.sin(dLon/2)**2;
  return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}

/* ======================================================
   GOOGLE MAPS
====================================================== */
function abrirGoogleMapsComGPS(){
  if(!posicaoUsuario){
    alert("Ative o GPS para navegar.");
    return;
  }
  const fim = (diaSelecionado===1?trajetoDia1:trajetoDia2).slice(-1)[0];
  const url = `https://www.google.com/maps/dir/?api=1&origin=${posicaoUsuario[0]},${posicaoUsuario[1]}&destination=${fim[0]},${fim[1]}&travelmode=walking`;
  window.open(url,"_blank");
}

/* ======================================================
   INIT
====================================================== */
mostrarDia(1);
localizarUsuario();

</script>

{% endblock %}
